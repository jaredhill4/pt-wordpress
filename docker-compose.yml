version: '3.3'

services:
  database:
    container_name: ${PROJECT_NAME}_database
    image: mysql:${MYSQL_VERSION}
    volumes:
      - ${DB_DUMP_DIR}:/docker-entrypoint-initdb.d
      - ${HOST_STORAGE_DIR}/data:/var/lib/mysql
    restart: always
    ports:
      - '${DB_EXTERNAL_PORT}:3306'
    environment:
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}

  node:
    container_name: ${PROJECT_NAME}_node
    build:
      context: .
      dockerfile: .docker/node/Dockerfile
      args:
        NODE_VERSION: ${NODE_VERSION}
    restart: always
    volumes:
      - ${HOST_THEME_DIR}:/app/
      - app_node_modules:/app/node_modules/

  web:
    container_name: ${PROJECT_NAME}_web
    depends_on:
      - database
      - node
    build:
      context: .
      dockerfile: .docker/web/Dockerfile
      args:
        PHP_VERSION: ${PHP_VERSION}
        NODE_VERSION: ${NODE_VERSION}
        WEB_ROOT_DIR: ${WEB_ROOT_DIR}
        ACF_PRO_KEY: ${ACF_PRO_KEY}
        COMPOSER_AUTH: '{"http-basic":{"composer.deliciousbrains.com":{"username":"${DELICIOUS_BRAINS_COMPOSER_API_USERNAME}","password":"${DELICIOUS_BRAINS_COMPOSER_API_PASSWORD}"}}}'
    restart: always
    ports:
      - '${WEB_EXTERNAL_PORT}:80'
    volumes:
      # Configuration files
      - ./.htaccess:${WEB_ROOT_DIR}/.htaccess
      - ./index.php:${WEB_ROOT_DIR}/index.php
      - ./wp-config.php:${WEB_ROOT_DIR}/wp-config.php

      # Persist changes to composer.lock file via `composer update`
      # so we can commit them back to our central GitHub repo
      - ./composer.lock:${WEB_ROOT_DIR}/composer.lock

      # Theme directory
      - ${HOST_THEME_DIR}:${WEB_ROOT_DIR}/app/themes/wlion/

      # Plugin directories
      - ${HOST_PLUGINS_DIR}/wlion-login-lockdown/:${WEB_ROOT_DIR}/app/plugins/wlion-login-lockdown/
      - ${HOST_PLUGINS_DIR}/wlion-wp-custom-system-emails/:${WEB_ROOT_DIR}/app/plugins/wlion-wp-custom-system-emails/

      # Named volumes
      - ${HOST_STORAGE_DIR}/uploads:${WEB_ROOT_DIR}/app/uploads/
      - app_node_modules:${WEB_ROOT_DIR}/app/themes/wlion/node_modules/

volumes:
  app_node_modules:
